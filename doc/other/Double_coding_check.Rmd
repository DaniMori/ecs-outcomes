---
title: "Double coding check"
output:
  html_notebook: default
  html_document:
    df_print: paged
    keep_md: true
---

# Introduction

This notebook performs the check on the double coding of the outcome variables.
It does the following:

1.  First, it loads the dataset generated with the original syntax

2.  Then, it runs the double coding syntax

3.  Then it collapses the variables from the two datasets, the old one, and the
    one with the variables generated by the double coding syntax
    
4.  Finally, it outputs a contingency table comparing the cases with the results
    of both datsets

```{r setup, message=FALSE, warning=FALSE}
library(haven)
library(tidyverse)
library(janitor)
library(rstudioapi)
library(stringr)
library(ecs.data)
library(Statamarkdown)
library(rmarkdown)
library(knitr)

options(knitr.kable.NA = '')
```

# Load data

**DO THE FOLLOWING:**

1. Change the value of the object `DATASET_NAME` in line 37 to reflect the name
   of the dataset to check

2. Run the chunk `load-data`

```{r load-data}
# DATASET_NAME <- "Outcome_[varname_qualifier].dta"
DATASET_NAME <- "Outcome_anthropometric_measures.dta"

C2019W4_FOLDER <- "../outcomes/cohorte_2011/ola_4/"

DATASET_PATH <- file.path(C2019W4_FOLDER, DATASET_NAME)

outcomes_original <- read_dta(DATASET_PATH, encoding = 'UTF-8')
```

# Paste double coding syntax

**DO THE FOLLOWING:**

1. Paste the double coding syntax in Stata chunk `double-coding` below.

```{stata double-coding, results='hide'}
use "~\\UAM\\Marta Miret Garcia - Bases de datos maestras Edad con Salud\\Ola_4\\Cohorte 2011\\rawdata_c2011w4.dta"

**# TODO: Paste double coding syntax here
recode q2506_height_s3 q2507_weight_s3 q2508_waist_s3(997=.)(998=.) 
gen height_s3=q2506_height_s3 if q2506_height_s3>=50 & q2506_height_s3<=200 
label variable height_s3 "Height, in cm (c2011_w4)" 
gen weight_s3=q2507_weight_s3 if q2507_weight_s3>=20 & q2507_weight_s3<=200 
label variable weight_s3 "Weight, in kg (c2011_w4)" 
gen waist_s3=q2508_waist_s3 if q2508_waist_s3>=40 & q2508_waist_s3<=300 
label variable waist_s3 "Waist circumference, in cm (c2011_w4)" 
***BMI (kg/m2) is defined as the weight (kg) divided by the square of the height (m)  
gen height_m=height_s3/100 
gen bmi_s3= weight_s3/(height_m*height_m) 
label variable bmi_s3 "Body mass index (kg/m2), continuous (c2011_w4)" 
*BMI-Four categories are created using the WHO BMI cut-off points. 
gen bmi_cat_s3=. 
replace bmi_cat_s3=1 if bmi_s3<18.5 
replace bmi_cat_s3=2 if bmi_s3>=18.5 & bmi_s3<25 
replace bmi_cat_s3=3 if bmi_s3>=25 & bmi_s3<30 
replace bmi_cat_s3=4 if bmi_s3>=30 & bmi_s3<50 
label define bmi1 1 "Underweight" 2 "Normal weight" 3 "Overweight" 4 "Obese" 
label values bmi_cat_s3 bmi1 
label variable bmi_cat_s3 "Body mass index, categorical (c2011_w4)"

* #ATTENTION: DO NOT DELETE THE FOLLOWING LINE:
saveold "throughput.dta", replace version(13)
```

# Run comparison {.tabset}

**DO THE FOLLOWING:**

1. Run and knit this notebook

```{r compare-dc, results='asis'}
#| echo: false

# Read the double coding dataset:
outcomes_dc <- read_dta("throughput.dta", encoding = 'UTF-8')
result <- file.remove("throughput.dta")

# Format the double coding dataset:

outcome_varnames <- outcomes_original |> select(-(ID_ECS:proxy_s3)) |> colnames()
outcome_varnames <- outcome_varnames |>
  setNames(outcome_varnames |> paste0('_dc'))

outcomes_dc <- outcomes_dc |> select(ID_ECS, !!!outcome_varnames)

# Collapse the datasets and compare the variables:

outcomes_collapsed <- outcomes_original |> full_join(outcomes_dc, by = "ID_ECS")

for (var in outcome_varnames) {
  
  cat('\n## `', var, '`\n\n\n', sep = '')
  
  var_dc <- var |> paste0('_dc')
  
  vars <- c(original = unname(var), dc = var_dc)
  
  counts_table <- outcomes_collapsed |>
    select(all_of(vars)) |>
    count(original, dc)
  
  counts_table |>
    pivot_wider(names_from = dc, values_from = n) |>
    kable() |>
    print()
  
  non_matching <- counts_table |>
    filter(original != dc) |>
    count(wt = n) |>
    pull()
  
  cat('\n\n\nNÂº of off-diagonal cases: ', non_matching, '\n', sep = '')
}
```

