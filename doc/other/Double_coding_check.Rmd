---
title: "Double coding check"
output:
  html_document:
    df_print: paged
    keep_md: true
  html_notebook:
    code_folding: hide
---

# Introduction

This notebook performs the check on the double coding of the outcome variables.
It does the following:

1.  First, it loads the dataset generated with the original syntax

2.  Then, it runs the double coding syntax

3.  Then it collapses the variables from the two datasets, the old one, and the
    one with the variables generated by the double coding syntax
    
4.  Finally, it outputs a contingency table comparing the cases with the results
    of both datsets

```{r setup, message=FALSE, warning=FALSE}
library(haven)
library(tidyverse)
library(janitor)
library(rstudioapi)
library(stringr)
library(ecs.data)
library(Statamarkdown)
library(rmarkdown)
library(knitr)

options(knitr.kable.NA = '')
```

# Load data

**DO THE FOLLOWING:**

1. Change the value of the object `DATASET_NAME` in line 50 to reflect the name
   of the dataset to check

2. Run the chunk `load-data`

```{r load-data}
DATASET_NAME <- "Outcome_[varname_qualifier].dta"

C2019W4_FOLDER <- "../outcomes/cohorte_2011/ola_4"

DATASET_PATH <- file.path(C2019W4_FOLDER, DATASET_NAME)

outcomes_original <- read_dta(DATASET_PATH, encoding = 'UTF-8')
```

# Paste double coding syntax

**DO THE FOLLOWING:**

1. Paste the double coding syntax in Stata chunk `double-coding` below.

```{stata double-coding, results='hide'}
use "~\\UAM\\Marta Miret Garcia - Bases de datos maestras Edad con Salud\\Ola_4\\Cohorte 2011\\rawdata_c2011w4.dta"

**# TODO: Paste double coding syntax here

* #ATTENTION: DO NOT DELETE THE FOLLOWING LINE:
saveold "throughput.dta", replace version(13)
```

# Run comparison {.tabset}

**DO THE FOLLOWING:**

1. Run the whole notebook typing `CTRL + ALT + R` (Windows)
   or `CMD + OPTION + R` (Mac)

2. Knit the notebook with `CTRL + SHIFT + K` (Windows)
   or `CMD + SHIFT + K` (Mac)

```{r compare-dc, results='asis'}
#| echo: false

# Read the double coding dataset:
outcomes_dc <- read_dta("throughput.dta", encoding = 'UTF-8')
result <- file.remove("throughput.dta")

# Format the double coding dataset:

outcome_varnames <- outcomes_original |>
  select(-(ID_ECS:proxy_s3))          |>
  colnames()

outcomes_dc <- outcomes_dc |> select(ID_ECS, all_of(outcome_varnames))

# Collapse the datasets and compare the variables:

outcome_varnames <- outcome_varnames |> setNames(outcome_varnames)
diff_values <- outcome_varnames |> imap_dfr(
  ~{
    original_var  <- outcomes_original |>
      select(ID_ECS, all_of(c(original = .x)))
    dc_var <- outcomes_dc |> select(ID_ECS, all_of(c(double_coding = .x)))
    
    full_join(original_var, dc_var, by = "ID_ECS")   |>
      filter(
        (original != double_coding) | (is.na(original) != is.na(double_coding))
      ) |>
      mutate(
        across(
          -ID_ECS,
          ~if (is.labelled(.)) as_factor(.) else as.character(.) |> as_factor()
        )
      )
  },
  .id = "Variable"
)
n_diff_values <- diff_values |> count(Variable)

cat('\n## NÂº of non-matching cases by variable:\n')

n_diff_values

cat('\n## Detail of non-missing cases:\n')

diff_values
```

