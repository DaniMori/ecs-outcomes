---
title: "Edad con Salud -- cohort 2011 -- wave 4 -- 'Health status'"
output:
  word_document:
    reference_docx: !expr ecs.data::get_pkg_docx_template()
bibliography: "`r ecs.data::get_proj_bib_file()`"
csl: "`r ecs.data::get_proj_csl_file()`"
nocite: '@caballero2017, @delafuente2018'
editor_options: 
  markdown:
    wrap: 80
params:
  test: true
  double-coding: false
---

```{r setup, include=FALSE}
# Activar los paquetes que R necesita para ejecutar el código:

library(Statamarkdown)

# Ruta al ejecutable de Stata (Ejecuta `sysdir` en Stata para encontrar la ruta)

STATA_PATH <- r"(C:/Program Files (x86)/Stata15/StataSE-64.exe)"


# Opciones de configuración de las salidas de R y Stata:

options(width = 88) # Ancho de salida de texto en R

knitr::opts_chunk$set( # Para todos los 'chunks' de código:
  engine.path = list(stata = STATA_PATH),
  echo        = FALSE, #   - No muestra la sintaxis en el documento
  results     = 'hide',#   - Omite los resultados de ejecutar la sintaxis
  cleanlog    = TRUE,  #   - Omite repetir sintaxis en resultados de Stata
  collectcode = TRUE,  #   - Reutiliza el código de Stata de 'chunks' anteriores
  comment     = ''     #   - No añade ningún prefijo a los resultados
)

TEST          <- params$test
DOUBLE_CODING <- params$`double-coding` & TEST
```

# Variable information

| Main variable name | Label                                      | Format     | Code  |
|:-------------------|:-------------------------------------------|:-----------|:------|
| health_s3          | Health, comparable across waves (c2011_w4) | continuous | 0-100 |

# Variable description

We have created a health score that can be compared (in terms of changes in
health scores) across the three waves of the COURAGE in Europe - Edad con Salud
project conducted in Spain. The metric of health was built from a set of
self-reported health questions and measured tests, common in both waves. The
procedure employed is based on a Bayesian multilevel Item Response Theory (IRT)
approach. A global score ranging from 0 to 100 was obtained, with higher scores
indicating better health, after considering a similar range of responses for
each of the items considered to build the metric.

# Explanation of how the variables were created

All the original self-reported health questions, responded on a 5-point Likert
scale from 1 ("None") to 5 ("Extreme / Cannot do") were dichotomized as
"presence" or "absence of difficulties", recoding every value higher than 1 to a
0. Variables recoded this way were the responses to the following items:
`Q2001`, `Q2003`, `Q2005`, `Q2006`, `Q2007`, `Q2009`, `Q2011`, `Q2012`, `Q2013`,
`Q2014`, `Q2015`, `Q2016`, `Q2017`, `Q2018`, `Q2019`, `Q2023`, `Q2024`, `Q2025`,
`Q2026`, `Q2027`, `Q2028`, `Q2029`, `Q2030`, `Q2031`, `Q2032`, `Q2034`, `Q2035`,
`Q2036`, `Q2037`, `Q2038`, `Q2039`, `Q2040`, `Q2041`, `Q2042`, `Q2043`, `Q2044`,
`Q2045`, `Q2046`, `Q2047`, `Q2048`, `Q2051`, and `Q2052`.

A similar categorization was employed for the measured tests, considering the
25^th^ percentile of the distribution as cut-off point: A score lower than the
25^th^ percentile of the distribution was considered as indicator of
difficulties, whereas scores higher than the 25^th^ percentile of the
distribution indicated the absence of difficulties.

A total of 43 self-reported health questions and seven measured tests were
identified in both waves. The measured tests employed in this survey included
*grip strength*, *walking speed*, and the following cognitive functioning tests:
*immediate verbal recall*, *delayed verbal recall*, *digit span backwards*,
*digit span forward* and *verbal fluency*.

After applying the Rasch IRT model, the latent score obtained was transformed
into a 0-100 scale, with higher scores indicating a better a health status. A
maximum of a 20% of missing values across the 50 variables was allowed before
creating the metric of health status; that is, if there were more than 10
missing values, the estimated score was recoded as a "missing".

# Syntax used to create the variable (Stata 15)

```{stata load-data}
* Cohorte 2011, ola 4:
use "~\UAM\Marta Miret Garcia - Bases de datos maestras Edad con Salud\Ola_4\Cohorte 2011\rawdata_c2011w4.dta"
```

```{stata generate-outcomes, echo=!DOUBLE_CODING}
*# Merge in ancillary datasets:
merge 1:1 ID_ECS using "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 4\Outcomes\Cohorte 2011\Outcome datasets\Outcome_gripstrength.dta", gen(merge_gs)
merge 1:1 ID_ECS using "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 4\Outcomes\Cohorte 2011\Outcome datasets\Outcome_cognition.dta", gen(merge_cog)


*# "Create new binary variables from the measured tests":

**# "Recode first into quartiles":
xtile ws_binary = q2513_4m_s3, nquantiles(4)
xtile ivr_binary = immediate_c_s3, nquantiles(4)
xtile dvr_binary = delayed_c_s3, nquantiles(4)
xtile dsb_binary = ds_backward_s3, nquantiles(4)
xtile dsf_binary = ds_forward_s3, nquantiles(4)
xtile vf_binary  = verbal_fluency_s3, nquantiles(4)

**# "Recode then as 0 (1st quartile) or 1 (the rest)":
recode ws_binary-vf_binary (1=0) (2=1) (3=1) (4=1)

*# TODO: Use 25-th centile cutoff instead of computed grip strength?
**# "Recode grip strength":
recode grip_s3 (1=0) (0=1)


*# "Recode item values":
recode q2001_activ_s3 q2007_pains_s3 q2009_difficulty_s3 q2003_vigor_s3 q2036_walk_s3 q2026_walk_s3 q2041_movement_s3 q2029_climb_s3 q2046_going_s3 q2045_movement_s3 q2030_crouch_s3 q2027_stand_s3 q2043_arising_s3 q2025_sitting_s3 q2028_stand_s3 q2031_pickup_s3 q2034_reach_s3 q2040_carry_s3 q2037_wash_s3 q2038_dress_s3 q2044_toilet_s3 q2042_eating_s3 q2005_appear_s3 q2006_stay_s3 q2035_concent_s3 q2011_learn_s3 q2033_activ_s3 q2012_relat_s3 q2013_confl_s3 q2014_friend_s3 q2015_strang_s3 q2032_hh_resp_s3 q2039_daily_s3 q2016_sleep_s3 q2017_rested_s3 q2018_depr_s3 q2019_worry_s3 q2047_affect_s3 q2048_interf_s3 q2023_vis_diff_s3 q2024_vis_diff_s3 q2051_hear_diff q2052_hear_diff_s3 (888=.) (2=0) (3=0) (4=0) (5=0)

*# "Run IRT model and estimate person parameter":
irt 1pl q2001_activ_s3 q2007_pains_s3 q2009_difficulty_s3 q2003_vigor_s3 q2036_walk_s3 q2026_walk_s3 q2041_movement_s3 q2029_climb_s3 q2046_going_s3 q2045_movement_s3 q2030_crouch_s3 q2027_stand_s3 q2043_arising_s3 q2025_sitting_s3 q2028_stand_s3 q2031_pickup_s3 q2034_reach_s3 q2040_carry_s3 q2037_wash_s3 q2038_dress_s3 q2044_toilet_s3 q2042_eating_s3 q2005_appear_s3 q2006_stay_s3 q2035_concent_s3 q2011_learn_s3 q2033_activ_s3 q2012_relat_s3 q2013_confl_s3 q2014_friend_s3 q2015_strang_s3 q2032_hh_resp_s3 q2039_daily_s3 q2016_sleep_s3 q2017_rested_s3 q2018_depr_s3 q2019_worry_s3 q2047_affect_s3 q2048_interf_s3 q2023_vis_diff_s3 q2024_vis_diff_s3 q2051_hear_diff q2052_hear_diff_s3

predict theta, latent

*# "Compute number of missing values and drop estimates when missing > 20%":
egen missing_count = rowmiss(q2001_activ_s3 q2007_pains_s3 q2009_difficulty_s3 q2003_vigor_s3 q2036_walk_s3 q2026_walk_s3 q2041_movement_s3 q2029_climb_s3 q2046_going_s3 q2045_movement_s3 q2030_crouch_s3 q2027_stand_s3 q2043_arising_s3 q2025_sitting_s3 q2028_stand_s3 q2031_pickup_s3 q2034_reach_s3 q2040_carry_s3 q2037_wash_s3 q2038_dress_s3 q2044_toilet_s3 q2042_eating_s3 q2005_appear_s3 q2006_stay_s3 q2035_concent_s3 q2011_learn_s3 q2033_activ_s3 q2012_relat_s3 q2013_confl_s3 q2014_friend_s3 q2015_strang_s3 q2032_hh_resp_s3 q2039_daily_s3 q2016_sleep_s3 q2017_rested_s3 q2018_depr_s3 q2019_worry_s3 q2047_affect_s3 q2048_interf_s3 q2023_vis_diff_s3 q2024_vis_diff_s3 q2051_hear_diff q2052_hear_diff_s3 grip_s3 ws_binary-vf_binary)
replace theta = . if missing_count>10

*# "Rescale and label":
generate health_s3 = (theta + 2.5594499) / (1.4086262 + 2.5594499) * 100
label var health_s3 "Health, comparable across waves (c2011_w4)"
```

<br> <!--# Salto de línea (i.e. párrafo vacío); añadir donde se necesite -->

```{stata descriptives, cleanlog=FALSE, collectcode=TRUE, results='markup', include=!DOUBLE_CODING}
keep ID_ECS q0007a_result proxy health_s3

codebook health_s3
```

```{stata save-data-test, eval=TEST}
saveold "Outcome_healthstatus_comparable.dta", replace version(13)
```

```{stata save-data, eval=!TEST}
* Cohorte 2011, ola 4:
saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 4\Outcomes\Cohorte 2011\Outcome datasets\Outcome_healthstatus_comparable.dta", replace version(13)
```

```{r generate-outcomes-r, echo=!DOUBLE_CODING, eval=FALSE, echo=FALSE}
library(haven)
library(tidyverse)
library(mirt)

survey_data <- read_dta(
  file.path(
    "~/../UAM",
    "Marta Miret Garcia - Bases de datos maestras Edad con Salud",
    "Ola_4/Cohorte 2011",
    "rawdata_c2011w4.dta"
  ),
  encoding = 'UTF-8'
)

WAVE4_SUFFIX <- '_s3'

HEALTH_ITEMS <- c(
  # General health status:
  "q2001_activ",
  
  # Pain & discomfort:
  "q2007_pains", "q2009_difficulty",
  
  # Mobility:
  "q2003_vigor",  "q2036_walk",    "q2026_walk",     "q2041_movement",
  "q2029_climb",  "q2046_going",   "q2045_movement", "q2030_crouch",
  "q2027_stand",  "q2043_arising", "q2025_sitting",  "q2028_stand",
  "q2031_pickup", "q2034_reach",   "q2040_carry",
  
  # Personal care:
  "q2037_wash",   "q2038_dress", "q2044_toilet", "q2042_eating",
  "q2005_appear", "q2006_stay", 
  
  # Cognition:
  "q2035_concent", "q2011_learn",
  
  # Interpersonal activities:
  "q2033_activ",  "q2012_relat", "q2013_confl",
  "q2014_friend", "q2015_strang",
  
  # Domestic life & work:
  "q2032_hh_resp", "q2039_daily", 
  
  # Sleep & energy:
  "q2016_sleep", "q2017_rested",
  
  # Affect:
  "q2018_depr", "q2019_worry", "q2047_affect", "q2048_interf",
  
  # Vision:
  "q2023_vis_diff", "q2024_vis_diff",
  
  # Hearing:
  "q2051_hear_diff", "q2052_hear_diff"
) |>
  paste0(WAVE4_SUFFIX)

# OTHER_VARS <- c(
#   "grip",
#   "wlkspeed",
#   "vrecall",         # TODO: Dependent on "cognition"
#   "q2535_score_s3",  # Digits backwards
#   "q2534_score_s3",  # Digits forwards
#   "q2536_score_s3",  # Verbal fluency
#   "q2544_recall_s3", # Delayed verbal recall
# )

health_status_data <- survey_data              |>
  rename(q2051_hear_diff_s3 = q2051_hear_diff) |> # Fix incorrect name
  transmute(
    ID_ECS,
    across(
      all_of(HEALTH_ITEMS),
      ~case_match(., 888 ~ NA, 2:5 ~ 0, .default = .)
    )
  )

# health_status_data <- survey_data |> select_at(HEALTH_VARS)

hs_irt_model <- health_status_data |>
  select(-ID_ECS)                  |>
  mirt(model = 1, itemtype = "Rasch")

hs_scores <- hs_irt_model |>
  fscores()               |>
  drop()

# Normalize the range to 0-100
min_hs           <- hs_scores |> min()
max_hs           <- hs_scores |> max()
hs_scores_rescaled <- (hs_scores - min_hs) / (max_hs - min_hs) * 100


hs_scores_stata <- read_stata(
  "doc/outcomes/cohorte_2011/ola_4/Outcome_healthstatus_comparable.dta",
  encoding = 'UTF-8'
)

cor(hs_scores_rescaled, hs_scores_stata$health_s3)
```

<br>

# Contact person:

-   Name: Daniel Morillo
-   e-mail:
    [daniel.morillo\@cibersam.es](mailto:daniel.morillo@cibersam.es){.email}
-   Phone number: (+34) 91 497 58 16

<br>

Original version:

-   Name: Darío Moreno-Agostino
-   e-mail: [dario.moreno\@uam.es](mailto:dario.moreno@uam.es){.email}

# References

::: {#refs}
:::

\newpage

# Session info

```{r, results='markup'}
devtools::session_info()
```
