---
title: "Edad con Salud -- cohort 2011 -- wave 4 -- 'Health status'"
output:
  word_document:
    reference_docx: !expr ecs.data::get_pkg_docx_template()
# bibliography: "`r ecs.data::get_proj_bib_file()`"
bibliography: ../../../../www/Edad_con_salud_outcome_vars.bib
csl: "`r ecs.data::get_proj_csl_file()`"
editor_options: 
  markdown:
    wrap: 80
params:
  test: true
  double-coding: false
---

```{r setup, include=FALSE}
# Activar los paquetes que R necesita para ejecutar el código:

library(Statamarkdown)

# Opciones de configuración de las salidas de R y Stata:

options(width = 88) # Ancho de salida de texto en R

knitr::opts_chunk$set( # Para todos los 'chunks' de código:
  echo        = FALSE, #   - No muestra la sintaxis en el documento
  results     = 'hide',#   - Omite los resultados de ejecutar la sintaxis
  cleanlog    = TRUE,  #   - Omite repetir sintaxis en resultados de Stata
  collectcode = TRUE,  #   - Reutiliza el código de Stata de 'chunks' anteriores
  comment     = ''     #   - No añade ningún prefijo a los resultados
)

TEST          <- params$test
DOUBLE_CODING <- params$`double-coding` & TEST
```

# Variable information

+------------------+------------------+------------------+------------------+
| Main variable    | Label            | Format           | Code             |
| name             |                  |                  |                  |
+:=================+:=================+:=================+:=================+
| health_s3        | Health,          | continuous       | 0-100            |
|                  | comparable       |                  |                  |
|                  | across waves     |                  |                  |
|                  | (c2011_w4)       |                  |                  |
+------------------+------------------+------------------+------------------+

# Variable description

We have created a health score that can be compared (in terms of changes in
health scores) across the three waves of the COURAGE in Europe - Edad con Salud
project conducted in Spain. The metric of health was built from a set of
self-reported health questions and measured tests, common in both waves. The
procedure employed is based on a Bayesian multilevel Item Response Theory (IRT)
approach. A global score ranging from 0 to 100 was obtained, with higher scores
indicating better health, after considering a similar range of responses for
each of the items considered to build the metric.

# Explanation of how the variables were created

All the original self-reported health questions, responded on a 5-point Likert
scale from 1 ("None") to 5 ("Extreme / Cannot do") were dichotomized as "presence"
or "absence of difficulties", recoding every value higher than 1 to a 0.
Variables recoded this way were the responses to the following items: `Q2001`,
`Q2003`, `Q2005`, `Q2006`, `Q2007`, `Q2009`, `Q2011`, `Q2012`, `Q2013`, `Q2014`,
`Q2015`, `Q2016`, `Q2017`, `Q2018`, `Q2019`, `Q2023`, `Q2024`, `Q2025`, `Q2026`,
`Q2027`, `Q2028`, `Q2029`, `Q2030`, `Q2031`, `Q2032`, `Q2034`, `Q2035`, `Q2036`,
`Q2037`, `Q2038`, `Q2039`, `Q2040`, `Q2041`, `Q2042`, `Q2043`, `Q2044`, `Q2045`,
`Q2046`, `Q2047`, `Q2048`, `Q2051`, and `Q2052`.

A similar categorization was employed for the measured tests, considering the
25^th^ percentile of the distribution as cut-off point: A score lower than the
25^th^ percentile of the distribution was considered as indicator of
difficulties, whereas scores higher than the 25^th^ percentile of the
distribution indicated the absence of difficulties.

A total of 43 self-reported health questions and seven measured tests were
identified in both waves. The measured tests employed in this survey included
_grip strength_, _walking speed_, and the following cognitive functioning tests:
_immediate verbal recall_, _delayed verbal recall_, _digit span backwards_,
_digit span forward_ and _verbal fluency_.

After applying the Rasch IRT model, the latent score obtained was transformed
into a 0-100 scale, with higher scores indicating a better a health status. A
maximum of a 20% of missing values across the 50 variables was allowed before
creating the metric of health status.

# Syntax used to create the variable (Stata 15)

```{r generate-outcomes, echo=!DOUBLE_CODING}
library(haven)
library(mirt)

survey_data <- read_dta(
  file.path(
    "~/../UAM",
    "Marta Miret Garcia - Bases de datos maestras Edad con Salud",
    "Ola_4/Cohorte 2011",
    "rawdata_c2011w4.dta"
  ),
  encoding = 'UTF-8'
)


HEALTH_ITEMS <- c(
  # General health status:
  "q2001_activ",
  
  # Pain & discomfort:
  "q2007_pains", "q2009_difficulty",
  
  # Mobility:
  "q2003_vigor",  "q2036_walk",    "q2026_walk",     "q2041_movement",
  "q2029_climb",  "q2046_going",   "q2045_movement", "q2030_crouch",
  "q2027_stand",  "q2043_arising", "q2025_sitting",  "q2028_stand",
  "q2031_pickup", "q2034_reach",   "q2040_carry",
  
  # Personal care:
  "q2037_wash",   "q2038_dress", "q2044_toilet", "q2042_eating",
  "q2005_appear", "q2006_stay", 
  
  # Cognition:
  "q2035_concent", "q2011_learn",
  
  # Interpersonal activities:
  "q2033_activ",  "q2012_relat", "q2013_confl",
  "q2014_friend", "q2015_strang",
  
  # Domestic life & work:
  "q2032_hh_resp", "q2039_daily", 
  
  # Sleep & energy:
  "q2016_sleep", "q2017_rested",
  
  # Affect:
  "q2018_depr", "q2019_worry", "q2047_affect", "q2048_interf",
  
  # Vision:
  "q2023_vis_diff", "q2024_vis_diff",
  
  # Hearing:
  "q2051_hear_diff", "q2052_hear_diff"
)

OTHER_VARS <- c(
  "grip",        "wlkspeed",  "vrecall",
  "dsbackwards", "dsforward", "vfluency",
  "dvrecall"
)


survey_data <- survey_data %>%
  mutate(across(all_of(HEALTH_VARS), na_if, 888))

health_status_data <- survey_data %>% select_at(HEALTH_VARS)

hs_irt_model <- health_status_data %>%
  mirt(model = 1, itemtype = "Rasch")

hs_scores <- hs_irt_model %>% fscores() %>% drop()

# Invert the scores so a higher score means a better health status
hs_scores <- -hs_scores

# Normalize the range to 0-100
range_hs           <- hs_scores %>% range()
hs_scores_rescaled <- (hs_scores - range_hs[1]) /
  (range_hs[2] - range_hs[1]) *
  100
```

<br> <!--# Salto de línea (i.e. párrafo vacío); añadir donde se necesite -->

```{stata descriptives, cleanlog=FALSE, collectcode=FALSE, results='markup', include=!DOUBLE_CODING}
* TODO: Sustituir '<variable(s) generada(s)>' por las variables del dataset
* TODO: Añadir `subsample_pre interview_pre` si procede (sólo para Cohorte 2019, Ola 1)
keep ID_ECS q0007a_result proxy <variable(s) generada(s)>

* TODO: Sustituir '<variable(s) generada(s)>' por las variables del dataset
codebook <variable(s) generada(s)>
```

```{stata save-data-test, eval=TEST}
* TODO: Sustituir '<variable>' y '<qualifier>' por los valores correspondientes
saveold "Outcome_<variable>_<qualifier>.dta", replace version(13)
```

```{stata save-data, eval=!TEST}
* TODO: Descomentar linea correspondiente a la cohorte y ola utilizada
* TODO: Comprobar que la ruta de destino coincide con la localización de `DOC`
* TODO: Sustituir '<variable>' y '<qualifier>' por los valores correspondientes

* Cohorte 2011, ola 1:
* saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 1 - Línea base\Outcomes\Outcome datasets\Outcome_<variable>_<qualifier>.dta", replace version(13) // TODO: Aviso! El acento en "Línea" puede dar problemas con la ruta del archivo

* Cohorte 2011, ola 2:
* saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 2\Outcomes\Outcome datasets\Outcome_<variable>_<qualifier>.dta", replace version(13)

* Cohorte 2011, ola 3:
* saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 3\Outcomes\Cohorte 2011\Outcome datasets\Outcome_<variable>_<qualifier>.dta", replace version(13)

* Cohorte 2011, ola 4:
* saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 4\Outcomes\Cohorte 2011\Outcome datasets\Outcome_<variable>_<qualifier>.dta", replace version(13)

* Cohorte 2019, ola 1:
* saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Ola 3\Outcomes\Cohorte 2019\Outcome datasets\Outcome_<variable>_<qualifier>.dta", replace version(13)

* Cohorte 2019, ola post-confinamiento:
* saveold "~\UAM\Marta Miret Garcia - Documentacion Edad con Salud\Edad con salud - Subestudio COVID\Outcomes\Outcome datasets\Outcome_<variable>_<qualifier>.dta", replace version(13)
```

<br>

# Contact person:

-   Name: Daniel Morillo
-   e-mail:
    [daniel.morillo\@cibersam.es](mailto:daniel.morillo@cibersam.es){.email}
-   Phone number: (+34) 91 497 58 16

<br>

Original version:

-   Name: Darío Moreno-Agostino
-   e-mail:
    [dario.moreno\@uam.es](mailto:dario.moreno@uam.es){.email}

# References

::: {#refs}
:::

\newpage

# Session info

```{r, results='markup'}
devtools::session_info()
```
